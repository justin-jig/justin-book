---
title: "Saga Transaction â€” ë¶„ì‚° íŠ¸ëœì­ì…˜ê³¼ ë³´ìƒ ì²˜ë¦¬"
date: 2025-10-26
version: "v1.1.0"
---

#### ìš”ì•½

- **Saga íŒ¨í„´**ì€ ë¶„ì‚° í™˜ê²½ì—ì„œ **2PC(2-Phase Commit)** ì—†ì´  
  ì—¬ëŸ¬ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ **ì´ë²¤íŠ¸ ì‹œí€€ìŠ¤ í˜•íƒœë¡œ ì—°ê²°**í•˜ê³ ,  
  ì‹¤íŒ¨ ì‹œ **ë³´ìƒ(Compensation) íŠ¸ëœì­ì…˜**ì„ ìˆ˜í–‰í•´ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì´ë‹¤.
- **â€œë¡œì»¬ íŠ¸ëœì­ì…˜ ë‹¨ìœ„ì˜ Eventually Consistent Systemâ€** ì„ ë§Œë“œëŠ” í•µì‹¬ ì„¤ê³„ íŒ¨í„´ì´ë‹¤.
- **ì½”ë ˆì˜¤ê·¸ë˜í”¼(Choreography)** ì™€ **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜(Orchestration)** ë‘ ê°€ì§€ êµ¬í˜„ ë°©ì‹ì´ ìˆë‹¤.

SagaëŠ” **2PCì˜ í•œê³„ë¥¼ ë„˜ì€ ë¶„ì‚° íŠ¸ëœì­ì…˜ì˜ í˜„ì‹¤ì  í•´ë²•**ì´ë‹¤.
ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰í•˜ë©´ì„œ,
ì‹¤íŒ¨ ì‹œ â€œë³´ìƒ ì´ë²¤íŠ¸â€ë¡œ ì´ì „ ìƒíƒœë¥¼ ë³µêµ¬í•œë‹¤.

ì´ë¡œì¨ ì‹œìŠ¤í…œì€ **Eventually Consistent** í•˜ë©°,
**í™•ì¥ì„±ê³¼ ë‚´ê³ ì¥ì„±, ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ ë³µì›ë ¥**ì„ ëª¨ë‘ í™•ë³´í•  ìˆ˜ ìˆë‹¤.

CQRS / Event Sourcingê³¼ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ
**ì¼ê´€ì„±Â·ë³µêµ¬ì„±Â·ì¶”ì ì„±Â·í™•ì¥ì„±**ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ì™„ì„±í˜• ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤.

**Outbox íŒ¨í„´ì´ë€?**
- ë¬¸ì œ ìƒí™©:
íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì¤‘ DBì—ëŠ” ì„±ê³µì ìœ¼ë¡œ ì €ì¥ëì§€ë§Œ, ë©”ì‹œì§€ ë¸Œë¡œì»¤(Kafka, RabbitMQ ë“±)ì—ëŠ” ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì§€ ì•Šê±°ë‚˜ ì‹¤íŒ¨í•˜ë©´ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•¨
- í•´ê²° ë°©ë²•:
ë©”ì‹œì§€ë¥¼ ì§ì ‘ ë¸Œë¡œì»¤ì— ë³´ë‚´ëŠ” ëŒ€ì‹ , DBì— ë©”ì‹œì§€ë¥¼ í•¨ê»˜ ì €ì¥í•˜ê³ ,
ë³„ë„ í”„ë¡œì„¸ìŠ¤ê°€ ë©”ì‹œì§€ë¥¼ ë¸Œë¡œì»¤ë¡œ ì „ì†¡í•˜ëŠ” ë°©ì‹

ê´€ê³„: OutboxëŠ” Sagaì˜ ë©”ì‹œì§€ ì „ì†¡ì„ ì•ˆì „í•˜ê²Œ í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë¨
- SagaëŠ” ê° ë‹¨ê³„ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•´ì•¼ í•¨
- ì´ ì´ë²¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ë¸Œë¡œì»¤ì— ë³´ë‚´ê¸° ìœ„í•´ Outbox íŒ¨í„´ì„ í™œìš©
- â†’ Saga + Outbox ì¡°í•©ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ë§¤ìš° í”í•œ êµ¬ì¡°

##### ì–¸ì œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ê°€

âœ… **ì í•©í•œ ê²½ìš°**

* í•˜ë‚˜ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œì„¸ìŠ¤ê°€ **ì—¬ëŸ¬ ì„œë¹„ìŠ¤(DB)** ë¥¼ ê±°ì¹  ë•Œ
* ê°•í•œ ì¼ê´€ì„± ëŒ€ì‹  **Eventually Consistency** ë¡œë„ ì¶©ë¶„í•œ ê²½ìš°
* ë³µì¡í•œ ê²°ì œ/ì£¼ë¬¸/ì˜ˆì•½/ì •ì‚°/ë°°ì†¡ ë“± ë©€í‹° ì„œë¹„ìŠ¤ ì—°ë™
* **CQRS / Event Sourcing / Outbox** ë¥¼ ì´ë¯¸ ì‚¬ìš©í•˜ëŠ” í™˜ê²½

âŒ **ë¶€ì í•©í•œ ê²½ìš°**

* ë‹¨ì¼ DB ë‚´ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¶©ë¶„í•  ë•Œ
* ë³´ìƒ ë¶ˆê°€ëŠ¥í•œ ì‘ì—…(ì˜ˆ: ì™¸ë¶€ ì†¡ê¸ˆ, ì¦‰ì‹œ irreversible API)
* ì‹¤ì‹œê°„ ê°•í•œ ì¼ê´€ì„±ì´ ì ˆëŒ€ì ìœ¼ë¡œ í•„ìš”í•œ ê²½ìš°

---

##### ì°¸ê³ ìë£Œ
- [Microservices Patterns - Chris Richardson](https://microservices.io/patterns/data/saga.html)

---

## 1. ì™œ Saga íŒ¨í„´ì„ ì‚¬ìš©í•˜ëŠ”ê°€

> â€œë¶„ì‚° í™˜ê²½ì—ì„œë„ **íŠ¸ëœì­ì…˜ ì¼ê´€ì„±**ì„ ìœ ì§€í•˜ë©´ì„œ,  
> ì‹œìŠ¤í…œì˜ **í™•ì¥ì„±ê³¼ ë³µì›ë ¥**ì„ ë™ì‹œì— í™•ë³´í•˜ê¸° ìœ„í•´.â€

| ë¬¸ì œ | Sagaì˜ í•´ê²° ë°©í–¥ |
|------|----------------|
| 2PC(2-Phase Commit) ë³µì¡ë„ | ë‹¨ì¼ ì„œë¹„ìŠ¤ ìˆ˜ì¤€ ë¡œì»¬ íŠ¸ëœì­ì…˜ë§Œ ìœ ì§€ |
| ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë¶ˆê°€ | **ë³´ìƒ(Compensation)** ì„ í†µí•œ ë…¼ë¦¬ì  ë¡¤ë°± |
| ë„¤íŠ¸ì›Œí¬/ì„œë¹„ìŠ¤ ì¥ì•  | **ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜** ë³µì› ë©”ì»¤ë‹ˆì¦˜ |
| ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ ì¦ê°€ | ëŠìŠ¨í•œ ê²°í•©(ì´ë²¤íŠ¸ ê¸°ë°˜ í˜‘ë ¥) êµ¬ì¡° |
| ìš´ì˜ ì¶”ì  ì–´ë ¤ì›€ | ìƒíƒœ ê¸°ë°˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ë„ì… (Saga State Machine) |

âœ… **í•µì‹¬ ì´ì **
1. **2PCë³´ë‹¤ ë‹¨ìˆœí•œ ë¶„ì‚° íŠ¸ëœì­ì…˜ ì²˜ë¦¬**  
2. **ì‹¤íŒ¨ ë‚´ì„±(Fault Tolerance)** ë° **Eventually Consistent ë³´ì¥**  
3. **ì„œë¹„ìŠ¤ ê°„ ë…ë¦½ ë°°í¬ì™€ ë³µêµ¬ ìš©ì´ì„± í™•ë³´**  
4. **CQRS / Event Sourcingê³¼ ìì—°ìŠ¤ëŸ¬ìš´ í†µí•©**

---

## 2. ì–´ë–¤ ì–¸ì–´ì™€ í”„ë ˆì„ì›Œí¬ì—ì„œ ì‚¬ìš©í•˜ëŠ”ê°€

| ì–¸ì–´ / ëŸ°íƒ€ì„ | ëŒ€í‘œ í”„ë ˆì„ì›Œí¬ / êµ¬í˜„ ë°©ì‹ | íŠ¹ì§• |
|----------------|------------------------------|------|
| **Java (Spring Boot)** | [Axon Framework](https://axoniq.io/), [Camunda](https://camunda.com/), Spring StateMachine | ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê¸°ë°˜ Saga êµ¬í˜„ ìš©ì´, JPA/Outbox í†µí•© |
| **Node.js (NestJS / Express)** | [NestJS CQRS Module](https://docs.nestjs.com/recipes/cqrs), Kafka / BullMQ | ì´ë²¤íŠ¸ ê¸°ë°˜ ì½”ë ˆì˜¤ê·¸ë˜í”¼ êµ¬í˜„ì— ìœ ë¦¬ |
| **Python (FastAPI)** | Celery / Dramatiq + Redis / RabbitMQ | ë¹„ë™ê¸° íƒœìŠ¤í¬ ê¸°ë°˜ ë³´ìƒ íŠ¸ëœì­ì…˜ ì„¤ê³„ |
| **Go (Go-kit / Temporal.io)** | [Temporal.io Saga API](https://temporal.io/) | ê°•ë ¥í•œ ì›Œí¬í”Œë¡œìš° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ê¸°ë°˜ |
| **.NET (C#)** | MassTransit / NServiceBus | ë©”ì‹œì§€ ê¸°ë°˜ Saga ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë‚´ì¥ ì§€ì› |

> ğŸ’¡ ëŒ€ë¶€ë¶„ì˜ í˜„ëŒ€ MSA í™˜ê²½ì—ì„œëŠ” Kafka, RabbitMQ, Redis Stream ë“±  
> **ë©”ì‹œì§• ê¸°ë°˜ ì´ë²¤íŠ¸ ë¸Œë¡œì»¤**ì™€ í•¨ê»˜ ì‚¬ìš©ëœë‹¤.

---

## 3. êµ¬ì¡° ê°œìš”

```mermaid
flowchart LR
  C[Client Request] --> A[Order Service]
  A -->|OrderCreatedEvent| B[Inventory Service]
  B -->|InventoryReservedEvent| D[Payment Service]
  D -->|PaymentApprovedEvent| E[Shipping Service]
  E -->|ShippingCompletedEvent| A

  A -. "ë³´ìƒ: CancelPayment / ReleaseInventory" .-> D
  D -. "ë³´ìƒ: Refund / Reversal" .-> B
```

> ê° ë‹¨ê³„ëŠ” **ìì‹ ì˜ ë¡œì»¬ íŠ¸ëœì­ì…˜**ì„ ìˆ˜í–‰í•˜ê³ ,
> ì„±ê³µ ì‹œ **ë‹¤ìŒ ë‹¨ê³„ ì´ë²¤íŠ¸**ë¥¼ ë°œí–‰í•˜ë©°, ì‹¤íŒ¨ ì‹œ **ë³´ìƒ íŠ¸ëœì­ì…˜**ì„ ìˆ˜í–‰í•œë‹¤.

---

## 4. ë‘ ê°€ì§€ êµ¬í˜„ ë°©ì‹

| ë°©ì‹                          | ì„¤ëª…                           | ì¥ì          | ë‹¨ì                |
| --------------------------- | ---------------------------- | ---------- | ---------------- |
| **ì½”ë ˆì˜¤ê·¸ë˜í”¼ (Choreography)**   | ì„œë¹„ìŠ¤ ê°„ ì´ë²¤íŠ¸ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°          | ë‹¨ìˆœ, ëŠìŠ¨í•œ ê²°í•© | íë¦„ ì¶”ì  ì–´ë ¤ì›€        |
| **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ (Orchestration)** | ì¤‘ì•™ **Orchestrator**ê°€ ë‹¨ê³„ë³„ë¡œ ì§€íœ˜ | ì œì–´Â·ê´€ì°°ì„± ë†’ìŒ  | ì¤‘ì•™ ì§‘ì¤‘ êµ¬ì¡°, ë³µì¡ë„ ì¦ê°€ |

---

### 4.1 ì½”ë ˆì˜¤ê·¸ë˜í”¼ (Choreography)

```mermaid
sequenceDiagram
  participant Order
  participant Inventory
  participant Payment
  participant Shipping

  Order->>Inventory: OrderCreated
  Inventory-->>Order: InventoryReserved
  Order->>Payment: PaymentRequested
  Payment-->>Order: PaymentApproved
  Order->>Shipping: ShippingRequested
  Shipping-->>Order: ShippingCompleted
```

> âœ… ê°„ë‹¨í•œ ì›Œí¬í”Œë¡œìš°ì— ì í•© (3~4ë‹¨ê³„ ì´í•˜)

---

### 4.2 ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ (Orchestration)

```mermaid
flowchart LR
  O[Saga Orchestrator] -->|Reserve| I[Inventory Service]
  O -->|Pay| P[Payment Service]
  O -->|Ship| S[Shipping Service]
  I --OK/Fail--> O
  P --OK/Fail--> O
  S --OK/Fail--> O
  O -. ë³´ìƒ í˜¸ì¶œ .-> C[Compensation Flow]
```

> âœ… ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš°ì— ì í•©
> (Camunda, Temporal, Axon, Spring StateMachine ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±)

---

## 5. ë³´ìƒ íŠ¸ëœì­ì…˜ ì„¤ê³„ ì›ì¹™

| ë‹¨ê³„ | Do (ì •ë°©í–¥)          | Undo (ë³´ìƒ)         |
| -- | ----------------- | ----------------- |
| ì¬ê³  | reserve(quantity) | release(quantity) |
| ê²°ì œ | authorize(amount) | refund(amount)    |
| ë°°ì†¡ | prepare(shipment) | cancel(shipment)  |

> ğŸ’¡ â€œë³´ìƒ íŠ¸ëœì­ì…˜ì€ ì„±ê³µ ë‹¨ê³„ì˜ ì—­ìˆœ(ìŠ¤íƒ ìˆœì„œ)â€ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•œë‹¤.

---

## 6. Java / Spring Boot ë””ë ‰í† ë¦¬ êµ¬ì¡° ì˜ˆì‹œ

```
src/
â””â”€â”€ main/
    â”œâ”€â”€ java/
    â”‚   â””â”€â”€ com/example/order/
    â”‚       â”œâ”€â”€ saga/
    â”‚       â”‚   â”œâ”€â”€ orchestrator/
    â”‚       â”‚   â”‚   â”œâ”€â”€ OrderSagaOrchestrator.java   // ì „ì²´ Saga ìƒíƒœ ê´€ë¦¬
    â”‚       â”‚   â”‚   â””â”€â”€ SagaState.java               // ì§„í–‰ ìƒíƒœ Enum
    â”‚       â”‚   â”œâ”€â”€ command/                         // Saga Command ì •ì˜
    â”‚       â”‚   â”‚   â”œâ”€â”€ ReserveInventoryCommand.java
    â”‚       â”‚   â”‚   â””â”€â”€ AuthorizePaymentCommand.java
    â”‚       â”‚   â”œâ”€â”€ event/                           // Saga Event ì •ì˜
    â”‚       â”‚   â”‚   â”œâ”€â”€ InventoryReserved.java
    â”‚       â”‚   â”‚   â””â”€â”€ PaymentAuthorized.java
    â”‚       â”‚   â”œâ”€â”€ compensation/                    // ë³´ìƒ ë¡œì§
    â”‚       â”‚   â”‚   â”œâ”€â”€ CancelPaymentCommand.java
    â”‚       â”‚   â”‚   â””â”€â”€ ReleaseInventoryCommand.java
    â”‚       â”‚   â””â”€â”€ listener/                        // ì´ë²¤íŠ¸ ìˆ˜ì‹ ê¸°
    â”‚       â”‚       â””â”€â”€ SagaEventListener.java
    â”‚       â”‚
    â”‚       â”œâ”€â”€ outbox/                              // Outbox íŒ¨í„´
    â”‚       â”‚   â”œâ”€â”€ OutboxEntity.java
    â”‚       â”‚   â””â”€â”€ OutboxRelay.java
    â”‚       â”‚
    â”‚       â”œâ”€â”€ domain/
    â”‚       â”‚   â”œâ”€â”€ entity/
    â”‚       â”‚   â””â”€â”€ event/
    â”‚       â””â”€â”€ presentation/
    â”‚           â””â”€â”€ OrderController.java
    â”‚
    â””â”€â”€ resources/
        â””â”€â”€ application.yml
```
---

## 7. ëª¨ë‹ˆí„°ë§ ë° í…ŒìŠ¤íŠ¸ ì „ëµ

| ì˜ì—­                | ë°©ë²•                                      |
| ----------------- | --------------------------------------- |
| **Saga ìƒíƒœ ì¶”ì **    | ìƒíƒœë¨¸ì‹  ê¸°ë°˜ ëŒ€ì‹œë³´ë“œ (Camunda / Axon Server)    |
| **E2E í…ŒìŠ¤íŠ¸**       | Testcontainers + Kafka / RabbitMQ ì‹œë®¬ë ˆì´ì…˜ |
| **íšŒê·€ í…ŒìŠ¤íŠ¸**        | ë³´ìƒ ì‹œë‚˜ë¦¬ì˜¤/íƒ€ì„ì•„ì›ƒ/ì¤‘ë³µ ì´ë²¤íŠ¸ ì¬í˜„                  |
| **Observability** | OpenTelemetry Trace IDë¡œ ê° ìŠ¤í… ì¶”ì          |

---
