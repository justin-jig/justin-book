---
title: "ë°ì´í„° ê´€ë¦¬ (Database & ORM)"
date: 2025-10-25
---

#### ìš”ì•½

- ORM(Object Relational Mapping)ì„ í™œìš©í•œ ë°ì´í„° ê³„ì¸µ êµ¬ì¡°ë¥¼ í‘œì¤€í™”í•œë‹¤.  
- íŠ¸ëœì­ì…˜(Transaction)ê³¼ ì»¤ë„¥ì…˜í’€(Connection Pool)ì„ ì•ˆì •ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì •ì˜í•œë‹¤.  
- FastAPI / Spring Boot / Express / NestJS ë“± ì£¼ìš” ë°±ì—”ë“œ í”„ë ˆì„ì›Œí¬ ê³µí†µìœ¼ë¡œ ì ìš© ê°€ëŠ¥í•˜ë‹¤.  
- ì„±ëŠ¥ ìµœì í™”, ì¿¼ë¦¬ ë¡œê¹…, ë§ˆì´ê·¸ë ˆì´ì…˜ ìë™í™”(Flyway, Prisma Migrate) ë“±ì˜ ì‹¤ë¬´ íŒ¨í„´ì„ í¬í•¨í•œë‹¤.

> ë°ì´í„° ê³„ì¸µì€ â€œAPIì˜ ì‹¬ì¥â€ì´ë‹¤.  
> ORMê³¼ íŠ¸ëœì­ì…˜ì˜ ì¼ê´€ì„± ì—†ì´ëŠ” ì–´ë–¤ ì„œë¹„ìŠ¤ë„ ì•ˆì •ì ìœ¼ë¡œ í™•ì¥í•  ìˆ˜ ì—†ë‹¤.


> ORMì€ ë‹¨ìˆœíˆ SQLì„ ìˆ¨ê¸°ëŠ” ë„êµ¬ê°€ ì•„ë‹ˆë¼,
> **íŠ¸ëœì­ì…˜ ì•ˆì •ì„±, ë°ì´í„° ì¼ê´€ì„±, í™•ì¥ì„±**ì„ ì„¤ê³„í•˜ëŠ” í•µì‹¬ ë ˆì´ì–´ì´ë‹¤.
>
> FastAPI, Spring Boot, Express, NestJS ëª¨ë‘
> â€œRepository + Transaction + Migrationâ€ êµ¬ì¡°ë¥¼ í‘œì¤€í™”í•˜ë©´
> ìœ ì§€ë³´ìˆ˜ì„±ê³¼ ìš´ì˜ ì•ˆì •ì„±ì´ í¬ê²Œ í–¥ìƒëœë‹¤.

##### Query Poolì´ë€?
- **Query Pool(ì¿¼ë¦¬ í’€)**ì€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ **ë¯¸ë¦¬ ì—¬ëŸ¬ ê°œ ìƒì„±í•´ë‘ê³  ì¬ì‚¬ìš©**í•˜ëŠ” ë°©ì‹
- ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆ ì—°ê²°ì„ ìƒì„±í•˜ëŠ” ëŒ€ì‹ , **í’€(pool)ì— ìˆëŠ” ì—°ê²°ì„ ë¹Œë ¤ ì‚¬ìš©**í•˜ê³  ë‹¤ì‹œ ë°˜í™˜
- **ì„±ëŠ¥ í–¥ìƒ**, **ë™ì‹œ ì²˜ë¦¬ ëŠ¥ë ¥ ì¦ê°€**, **ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ ë°©ì§€**ì— íš¨ê³¼ì 

---

##### ì°¸ê³ ìë£Œ
- [SQLAlchemy Docs (FastAPI)](https://docs.sqlalchemy.org/en/20/)
- [Spring Data JPA Docs](https://spring.io/projects/spring-data-jpa)
- [TypeORM Docs (NestJS / Express)](https://typeorm.io/)
- [Prisma Docs](https://www.prisma.io/docs)
- [Flyway / Liquibase Docs](https://flywaydb.org/documentation/)
- [ACID Transactions Overview (PostgreSQL)](https://www.postgresql.org/docs/current/transaction-iso.html)

---

#### 1. ë°ì´í„° ê³„ì¸µ êµ¬ì¡°

| ê³„ì¸µ | ì—­í•  | ëŒ€í‘œ êµ¬ì„± ìš”ì†Œ |
|------|------|----------------|
| **Entity / Model** | DB í…Œì´ë¸” êµ¬ì¡° ì •ì˜ | ORM í´ë˜ìŠ¤, ìŠ¤í‚¤ë§ˆ |
| **Repository / DAO** | CRUD, Query ìˆ˜í–‰ | ORM ì¸í„°í˜ì´ìŠ¤ |
| **Service** | íŠ¸ëœì­ì…˜ ë‹¨ìœ„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | Commit / Rollback ê´€ë¦¬ |
| **Database** | ì‹¤ì œ ì €ì¥ì†Œ | PostgreSQL / MySQL / SQLite ë“± |

```mermaid
flowchart TD
  A[Controller] --> B[Service]
  B --> C[Repository]
  C --> D[(Database)]
  D --> C --> B --> A
````

---

#### 2. ORM êµ¬ì„± ë° ì˜ˆì‹œ

##### ğŸ FastAPI (SQLAlchemy)

```python
from sqlalchemy import Column, Integer, String
from database import Base

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50))
    email = Column(String(100), unique=True)
```

```python
# repository.py
from sqlalchemy.orm import Session

def get_user_by_id(db: Session, user_id: int):
    return db.query(User).filter(User.id == user_id).first()
```

---

##### â˜• Spring Boot (JPA)

```java
@Entity
@Table(name = "users")
public class User {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String email;
}
```

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
}
```

---

##### ğŸŸ¦ Express (Prisma ORM)

```javascript
// prisma/schema.prisma
model User {
  id    Int    @id @default(autoincrement())
  name  String
  email String @unique
}
```

```javascript
import { PrismaClient } from '@prisma/client'
const prisma = new PrismaClient()

export async function getUserById(id) {
  return await prisma.user.findUnique({ where: { id: Number(id) } })
}
```

---

##### ğŸ§± NestJS (TypeORM)

```typescript
@Entity('users')
export class User {
  @PrimaryGeneratedColumn() id: number;
  @Column() name: string;
  @Column({ unique: true }) email: string;
}
```

```typescript
@Injectable()
export class UserRepository {
  constructor(@InjectRepository(User) private repo: Repository<User>) {}
  async findById(id: number) {
    return await this.repo.findOne({ where: { id } });
  }
}
```

---

#### 3. íŠ¸ëœì­ì…˜ ê´€ë¦¬ (Transaction Management)

> íŠ¸ëœì­ì…˜ì€ â€œí•œ ë‹¨ìœ„ ì‘ì—…ì˜ ì›ìì„±(Atomicity)â€ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ í•µì‹¬ ìš”ì†Œì´ë‹¤.

##### ê³µí†µ ì›ì¹™

| ê°œë…              | ì„¤ëª…                              |
| --------------- | ------------------------------- |
| **Atomicity**   | ëª¨ë“  ì‘ì—…ì´ ì „ë¶€ ìˆ˜í–‰ë˜ê±°ë‚˜ ì „ë¶€ ì·¨ì†Œë˜ì–´ì•¼ í•¨      |
| **Consistency** | ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥                      |
| **Isolation**   | ë³‘ë ¬ ì²˜ë¦¬ ì‹œ ê°„ì„­ ë°©ì§€ (Isolation Level) |
| **Durability**  | Commit í›„ ì˜êµ¬ ë³´ì¡´                  |

---

##### ğŸ FastAPI (SQLAlchemy)

```python
from sqlalchemy.orm import Session

def update_user_email(db: Session, user_id: int, email: str):
    user = db.query(User).get(user_id)
    if not user:
        raise ValueError("User not found")
    user.email = email
    db.commit()
    db.refresh(user)
    return user
```

---

##### â˜• Spring Boot

```java
@Service
@Transactional
public class UserService {
    @Autowired private UserRepository repo;

    public void updateEmail(Long id, String email) {
        User user = repo.findById(id).orElseThrow();
        user.setEmail(email);
    } // @Transactional â†’ ìë™ commit
}
```

---

##### ğŸŸ¦ Express (Prisma)

```javascript
await prisma.$transaction(async (tx) => {
  const user = await tx.user.findUnique({ where: { id: 1 } });
  await tx.user.update({ where: { id: 1 }, data: { email: "new@email.com" } });
});
```

---

##### ğŸ§± NestJS (TypeORM)

```typescript
await this.dataSource.transaction(async (manager) => {
  const user = await manager.findOne(User, { where: { id: 1 } });
  user.email = "new@email.com";
  await manager.save(user);
});
```

---

#### 4. ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬ (Connection Pool)

| í”„ë ˆì„ì›Œí¬              | ì„¤ì • ë°©ë²•                                          | ë¹„ê³              |
| ------------------ | ---------------------------------------------- | -------------- |
| **FastAPI**        | `create_engine(pool_size=10, max_overflow=20)` | SQLAlchemy     |
| **Spring Boot**    | HikariCP (`spring.datasource.hikari.*`)        | ê¸°ë³¸ ë‚´ì¥          |
| **Express/NestJS** | Prisma/TypeORM Pool ì„¤ì •                         | DB ë“œë¼ì´ë²„ë³„ ì—°ê²° ì œì–´ |

> ì»¤ë„¥ì…˜ í’€ì€ DB ì—°ê²° ì¬í™œìš©ì„ í†µí•´ ì„±ëŠ¥ê³¼ ì•ˆì •ì„±ì„ ë™ì‹œì— í™•ë³´í•˜ëŠ” í•µì‹¬ êµ¬ì„± ìš”ì†Œì´ë‹¤.

---

#### 5. ì¿¼ë¦¬ ìµœì í™” & Lazy Loading

| ê¸°ë²•                        | ì„¤ëª…                               |
| ------------------------- | -------------------------------- |
| **Select N+1 ë°©ì§€**         | Fetch Join, Eager Loading ì‚¬ìš©     |
| **ì¸ë±ìŠ¤ ìµœì í™”**               | Query Plan í™•ì¸, ë¶ˆí•„ìš”í•œ Full Scan ë°©ì§€ |
| **Query Cache**           | Redis ë“± ì™¸ë¶€ ìºì‹œ í™œìš©                 |
| **Batch Insert / Update** | ë‹¤ì¤‘ ì²˜ë¦¬ë¡œ round-trip ìµœì†Œí™”            |

##### Spring Boot ì˜ˆì‹œ

```java
@Query("SELECT u FROM User u JOIN FETCH u.orders WHERE u.id = :id")
User findUserWithOrders(@Param("id") Long id);
```

##### NestJS ì˜ˆì‹œ

```typescript
await this.repo.find({
  relations: ['orders'],
  where: { id: userId }
});
```

---

#### 6. ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ (Schema Migration)

| ë„êµ¬                 | ì£¼ìš” ê¸°ëŠ¥              | í”„ë ˆì„ì›Œí¬          |
| ------------------ | ------------------ | -------------- |
| **Flyway**         | SQL ê¸°ë°˜ ì´ë ¥ ê´€ë¦¬       | Spring Boot    |
| **Liquibase**      | XML/YAML ê¸°ë°˜ ë§ˆì´ê·¸ë ˆì´ì…˜ | Java/Kotlin    |
| **Prisma Migrate** | ìë™ ëª¨ë¸ ë³€ê²½ ì¶”ì         | Express/NestJS |
| **Alembic**        | Python ORMìš© ë§ˆì´ê·¸ë ˆì´ì…˜ | FastAPI        |

##### Flyway ì˜ˆì‹œ

```
V1__init_schema.sql
V2__add_email_index.sql
```

##### Prisma Migrate ì˜ˆì‹œ

```
npx prisma migrate dev --name add_email_unique
```

---

#### 7. ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì „ëµ

| ì „ëµ                 | ì„¤ëª…                              |
| ------------------ | ------------------------------- |
| **In-memory DB**   | H2 / SQLite / Testcontainers í™œìš© |
| **Rollback í…ŒìŠ¤íŠ¸**   | íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ í…ŒìŠ¤íŠ¸ í›„ ìë™ ë¡¤ë°±            |
| **Fixture ê¸°ë°˜ í…ŒìŠ¤íŠ¸** | Mock ë°ì´í„° ì£¼ì…                     |
| **í†µí•© í…ŒìŠ¤íŠ¸**         | ì‹¤ì œ ORM ë ˆì´ì–´ì™€ DB í†µí•© ê²€ì¦            |

##### Spring ì˜ˆì‹œ

```java
@DataJpaTest
public class UserRepositoryTest {
    @Autowired private UserRepository repo;
    @Test void testSaveUser() {
        repo.save(new User("test", "a@b.com"));
    }
}
```

---



