---
title: "Shutdown 구성"
date: 2025-10-24
---

**version**  
Express 5.x / Node.js 22.x
---

### 요약  
Graceful Shutdown은 애플리케이션이 종료될 때,  
기존 요청을 안전하게 처리하고 자원(DB 연결, 캐시, 세션 등)을 정리한 뒤 프로세스를 종료하는 절차를 의미한다.  
이 문서는 Express 5.x 환경에서 안전한 종료(Graceful Termination)를 구현하는 방법을 설명한다.  
Graceful Shutdown은 서버 종료 과정에서 요청 손실을 방지하고 자원을 안정적으로 해제하기 위한 필수 절차이다.
Express 5.x 환경에서는 `server.close()`, 시그널 핸들러, 자원 정리 함수를 함께 사용해 구현할 수 있다.
운영 환경에서는 SIGTERM 기반 종료를 기본으로 하며,
쿠버네티스나 Docker에서 설정된 종료 대기 시간 내에 정상 종료되도록 구성해야 한다.

핵심 내용은 다음과 같다.  
- Graceful Shutdown의 개념과 필요성  
- Express 서버 종료 처리 절차  
- SIGINT / SIGTERM 시그널 처리  
- 데이터베이스 연결 및 캐시 클라이언트 종료  
- 운영 환경에서의 자동 재시작 전략  

Graceful Shutdown을 적용하면 서비스 중단 시에도 데이터 손실이나 요청 누락을 방지할 수 있으며,  
쿠버네티스·PM2·Docker와 같은 환경에서 안정적인 종료를 보장한다.

---

##### 참고자료  
- [Node.js Process Signal Handling](https://nodejs.org/api/process.html#signal-events)  
- [Express 공식 문서 – Application Lifecycle](https://expressjs.com/en/advanced/best-practice-performance.html#graceful-shutdown)  
- [Kubernetes Graceful Termination](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination)  

---

#### 1. Graceful Shutdown의 개념  

Graceful Shutdown은 서버가 종료 신호(SIGINT, SIGTERM 등)를 받았을 때,  
다음 절차를 순차적으로 수행하여 안정적으로 종료하는 프로세스이다.

1. 신규 요청 수락 중단 (서버 리스너 닫기)  
2. 진행 중인 요청이 모두 완료될 때까지 대기  
3. 데이터베이스, 캐시, 메시지 큐 등 연결 자원 정리  
4. 로그 및 버퍼 저장 후 프로세스 종료  

---

#### 2. Express 종료 핸들러 구성  

Express 서버는 `app.listen()`으로 시작된 후,  
`server.close()`를 호출해야 새로운 요청을 받지 않게 된다.  
아래는 기본적인 종료 핸들러 구현 예시이다.

```typescript
// src/server.ts
import app from "./app";
import { config } from "./config/env";

const PORT = config.port ?? 3000;
const server = app.listen(PORT, () => {
  console.log(`🚀 Server running at http://localhost:${PORT}`);
});

const shutdown = () => {
  console.log("🧩 Graceful shutdown initiated...");
  server.close(() => {
    console.log("✅ HTTP server closed.");
    // 필요한 자원 정리
    process.exit(0);
  });
};

process.on("SIGTERM", shutdown); // 시스템 종료 신호
process.on("SIGINT", shutdown);  // Ctrl + C (로컬 종료)
```

이 코드에서는 종료 시그널이 감지되면 새로운 요청을 차단하고,
남은 연결을 정리한 뒤 안전하게 프로세스를 종료한다.

---

#### 3. 비동기 자원 종료 처리

DB나 캐시 연결이 있는 경우, 종료 시점에서 해당 자원을 정리해야 한다.
예시는 Prisma ORM과 Redis를 사용하는 경우이다.

```typescript
// src/utils/shutdown.ts
import { prisma } from "../prisma/client";
import { redisClient } from "../config/redis";

export const cleanupResources = async () => {
  console.log("🧹 Cleaning up resources...");
  await prisma.$disconnect();
  await redisClient.quit();
};
```

`server.close()` 콜백 안에서 `cleanupResources()`를 호출하면
DB와 캐시 연결을 안전하게 해제할 수 있다.

---

#### 4. 요청 처리 대기 로직

진행 중인 요청이 모두 끝나기 전에 프로세스를 종료하면
트랜잭션 손실이나 응답 누락이 발생할 수 있다.
다음 코드는 요청 수를 추적해 모든 요청이 끝나면 종료하는 방법이다.

```typescript
let activeRequests = 0;

app.use((req, res, next) => {
  activeRequests++;
  res.on("finish", () => activeRequests--);
  next();
});

const shutdown = async () => {
  console.log("📦 Waiting for active requests to finish...");
  const checkInterval = setInterval(() => {
    if (activeRequests === 0) {
      clearInterval(checkInterval);
      console.log("✅ All requests completed.");
      process.exit(0);
    }
  }, 500);
};
```

---

#### 5. 운영 환경에서의 종료 시그널

| 환경                | 시그널                   | 설명                     |
| ----------------- | --------------------- | ---------------------- |
| **Docker**        | SIGTERM               | 컨테이너 중단 시 전달           |
| **Kubernetes**    | SIGTERM + GracePeriod | Pod 종료 시 전달, 기본 30초 대기 |
| **PM2**           | SIGINT / SIGTERM      | 프로세스 재시작 시 발생          |
| **Linux Systemd** | SIGTERM               | 서비스 중지 시 발생            |

운영 환경에서는 `SIGTERM` 신호가 주로 사용되며,
`process.on("SIGTERM")`으로 처리하는 것이 일반적이다.

쿠버네티스의 경우 `terminationGracePeriodSeconds` 설정을 통해
종료 대기 시간을 명시할 수 있다.

```yaml
spec:
  terminationGracePeriodSeconds: 20
```

---

#### 6. 로그 및 재시작 전략

Graceful Shutdown 이후에는 자동 복구를 위한 재시작 메커니즘을 설정할 수 있다.

| 도구                 | 설정 방식                   | 설명             |
| ------------------ | ----------------------- | -------------- |
| **PM2**            | `pm2 restart app`       | 장애 발생 시 자동 재시작 |
| **Docker Compose** | `restart: always`       | 컨테이너 종료 후 재시작  |
| **Kubernetes**     | `restartPolicy: Always` | Pod 자동 재생성     |

로그는 종료 직전에 반드시 플러시(flush)되어야 하며,
`winston`, `pino` 등의 로거에서 비동기 출력 대기 옵션을 활성화한다.

---

#### 7. Express 종료 플로우

```mermaid
%%{init: {"theme": "default", "themeVariables": {"fontSize": "14px"}}}%%
flowchart TD
    A[종료 시그널 수신<br/>(SIGINT/SIGTERM)] --> B[서버 수신 중단<br/>(server.close)]
    B --> C[진행 중 요청 대기]
    C --> D[DB / 캐시 연결 종료]
    D --> E[로그 플러시]
    E --> F[프로세스 종료 (exit 0)]
```

이 플로우는 Express 서버가 종료될 때의 전체 단계를 시각적으로 표현한다.

---

