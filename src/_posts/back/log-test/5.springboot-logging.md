---
title: "Backend Logging & Testing Guide — Flask 로깅 구조"
date: 2025-10-26
---


#### 요약

- Flask는 Python 표준 `logging` 모듈을 기반으로,  
  `before_request`, `after_request`, `teardown_request` 훅을 활용해  
  **요청 단위 로깅(Request-Level Logging)** 을 구현할 수 있다.  
- 본 장에서는 **구조적 JSON 로그 구성**, **Trace Context 전파**,  
  **에러 핸들링 로깅**, **pytest 기반 테스트 검증**을 포함한 실무 구성을 다룬다.

> Flask의 로깅은 Python 표준 로거를 기반으로,  
> **Hook 기반 Trace 관리 + JSON 구조화 + ContextVar 전파** 로 일관성 있게 구성할 수 있다.  
> 다음 장에서는 Spring Boot 환경에서의 `SLF4J + Logback + MDC` 기반 로깅 구조를 다룬다.

**핵심 요약**
1. Python `logging` 모듈 기반 구조적 로그(JSONFormatter)  
2. Flask Hook(`before_request`, `after_request`) 기반 요청/응답 로깅  
3. `ContextVar`를 이용한 Trace ID 전파  
4. 예외 핸들러를 통한 에러 로깅 통합  
5. Pytest로 로그 출력 및 Trace 유효성 검증  

---


#### 1. 기본 로깅 구성

**1.1 의존성 설치**
```bash
pip install flask python-json-logger
```

**1.2 로거 설정 (`logger.py`)**

```python
import logging
from pythonjsonlogger import jsonlogger

logger = logging.getLogger("flask-api")
logger.setLevel(logging.INFO)

handler = logging.StreamHandler()
formatter = jsonlogger.JsonFormatter(
    fmt="%(asctime)s %(levelname)s %(name)s %(message)s"
)
handler.setFormatter(formatter)
logger.addHandler(handler)
```

| 항목 | 설명 |
|------|------|
| **python-json-logger** | Python 표준 로거를 JSON 형식으로 확장 |
| **StreamHandler** | 콘솔로 로그 출력 |
| **asctime / levelname / name / message** | JSON 필드로 변환되는 기본 로그 속성 |

---

#### 2. Trace Context 관리 (ContextVar)

Flask는 스레드 기반이 아니므로, 요청 간 Trace ID 관리를 위해  
`ContextVar`를 사용하는 것이 안전하다.

**2.1 Trace Context (`trace_context.py`)**

```python
from contextvars import ContextVar
import uuid

trace_id_var = ContextVar("trace_id", default=None)

def set_trace_id(trace_id=None):
    trace_id_var.set(trace_id or str(uuid.uuid4()))

def get_trace_id():
    return trace_id_var.get()
```

---

#### 3. 요청/응답 로깅 Hook 구성

**3.1 요청 전(before_request) Trace ID 설정**

```python
from flask import Flask, request
from logger import logger
from trace_context import set_trace_id, get_trace_id

app = Flask(__name__)

@app.before_request
def before_request():
    trace_id = request.headers.get("X-Trace-Id")
    set_trace_id(trace_id)
    logger.info({
        "traceId": get_trace_id(),
        "method": request.method,
        "path": request.path,
        "message": "Request received"
    })
```

**3.2 응답 후(after_request) 로깅**

```python
@app.after_request
def after_request(response):
    logger.info({
        "traceId": get_trace_id(),
        "status": response.status_code,
        "message": "Response sent"
    })
    return response
```

**3.3 요청 종료 시(teardown_request) 에러 로깅**

```python
@app.teardown_request
def teardown_request(error=None):
    if error:
        logger.error({
            "traceId": get_trace_id(),
            "error": str(error),
            "message": "Unhandled Exception"
        })
```

---

#### 4. 예외 처리 통합

Flask의 전역 예외 핸들러를 이용하면  
모든 예외를 구조적으로 기록할 수 있다.

**4.1 에러 핸들러 등록**

```python
@app.errorhandler(Exception)
def handle_exception(e):
    logger.exception({
        "traceId": get_trace_id(),
        "message": f"Exception: {str(e)}"
    })
    return {"error": "Internal Server Error", "traceId": get_trace_id()}, 500
```

> **Note:**  
> `logger.exception()`은 자동으로 stack trace를 포함하며,  
> `errorhandler(Exception)`는 모든 예외를 포괄적으로 처리한다.

---

#### 5. 로그 출력 예시

**요청 성공 로그**
```json
{
  "asctime": "2025-10-26 03:01:23,812",
  "levelname": "INFO",
  "name": "flask-api",
  "traceId": "b1c9-9921-34aa",
  "method": "POST",
  "path": "/api/orders",
  "message": "Request received"
}
```

**에러 로그**
```json
{
  "asctime": "2025-10-26 03:02:01,245",
  "levelname": "ERROR",
  "name": "flask-api",
  "traceId": "b1c9-9921-34aa",
  "message": "Unhandled Exception",
  "error": "KeyError: 'amount'"
}
```

---

#### 6. 테스트 (Pytest)

**6.1 샘플 테스트 (`test_logging.py`)**

```python
import pytest
from app import app
from logger import logger

@pytest.fixture
def client():
    with app.test_client() as client:
        yield client

def test_logging_traceid(client, caplog):
    caplog.set_level("INFO")
    response = client.get("/health")
    assert response.status_code == 200
    logs = [r for r in caplog.records if "traceId" in r.message]
    assert len(logs) > 0
```

| 테스트 항목 | 검증 내용 |
|--------------|------------|
| **Trace ID 출력** | 요청/응답 로그에 `traceId` 포함 |
| **에러 발생 시 로그** | `logger.error()` 호출 확인 |
| **JSON 포맷 검증** | 로그 포맷이 JSON 구조로 유지 |
| **성능 검증** | 로그 출력으로 인한 응답 지연이 없음 |

---

#### 7. 운영 환경 고려사항

| 항목 | 권장 설정 |
|------|------------|
| **Level** | `INFO` 이상 |
| **Handler** | FileHandler or RotatingFileHandler |
| **Formatter** | `python-json-logger` |
| **Trace 전파** | `X-Trace-Id` 헤더 기반 |
| **로깅 분리** | Access Log / Error Log 파일 분리 |

**Flask + Gunicorn 환경 예시**
```bash
gunicorn app:app --access-logfile access.log --error-logfile error.log
```
