---
title: "Prisma Technical"
date: 2025-10-25
---

**version: NestJS v10.x / Prisma v5.x / Node.js v20 LTS 기준**

개념 / 구조 / 설치 / DI 연동 / CRUD / 장단점

#### 요약

Prisma는 **Schema-first** 접근을 채택한 타입-세이프 ORM으로, 선언적인 `schema.prisma`를 기반으로 **자동 생성된 클라이언트**를 통해 DB에 접근한다.  
NestJS에서는 **PrismaService**를 DI 컨테이너에 등록해 재사용하며, **마이그레이션 자동화**, **타입 안정성**, **빠른 생산성**에 강점이 있다.

**핵심 포인트**
- Schema-first + 타입 세이프 클라이언트
- NestJS DI: `PrismaService` (connect/disconnect lifecycle)
- 간결한 트랜잭션 API와 관계 로딩(`include`, `select`)
- `prisma migrate` 기반 마이그레이션 자동화
- 로그·성능·인덱스 최적화 전략

##### 장점 및 한계

| 항목     | Prisma      | 설명               |
| ------ | ----------- | ---------------- |
| 타입 안정성 | ✅ 강력한 타입 보장 | TS 기반 자동 생성      |
| 학습 난이도 | 낮음          | 명시적 Schema 정의    |
| 복잡 쿼리  | 보통          | QueryBuilder 미지원 |
| 마이그레이션 | 자동화 우수      | CLI 통합           |
| 성능     | 경량·빠름       | 러닝타임 오버헤드 적음     |

---

##### 참고자료
- Prisma Docs: https://www.prisma.io/docs
- NestJS with Prisma: https://docs.nestjs.com/recipes/prisma
- SQL Indexing: https://use-the-index-luke.com/

---

#### 1. 설치 및 초기화

```bash
pnpm add prisma @prisma/client
pnpx prisma init
```

기본 구조

```
prisma/
 ├── schema.prisma
 └── migrations/
```

`.env` 예시

```env
DATABASE_URL="postgresql://user:pw@localhost:5432/mydb?schema=public"
```

---

#### 2. NestJS 연동 (DI 구성)

`prisma.service.ts`

```ts
import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
  async onModuleInit() { await this.$connect(); }
  async onModuleDestroy() { await this.$disconnect(); }
}
```

`prisma.module.ts`

```ts
import { Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Module({ providers: [PrismaService], exports: [PrismaService] })
export class PrismaModule {}
```

---

#### 3. 스키마 설계와 관계 매핑

`schema.prisma`

```prisma
datasource db { provider = "postgresql"; url = env("DATABASE_URL") }
generator client { provider = "prisma-client-js" }

model User {
  id    Int     @id @default(autoincrement())
  name  String
  posts Post[]
  @@index([name])
}

model Post {
  id      Int    @id @default(autoincrement())
  title   String
  userId  Int
  user    User   @relation(fields: [userId], references: [id])
}
```

관계 로딩

```ts
this.prisma.user.findMany({ include: { posts: true } });
```

---



#### 4. CRUD 예시

```ts
@Injectable()
export class UserService {
  constructor(private readonly prisma: PrismaService) {}

  create(dto: { name: string }) {
    return this.prisma.user.create({ data: dto });
  }

  findAll() {
    return this.prisma.user.findMany({ include: { posts: true } });
  }
}
```
---

#### 5. 마이그레이션 & 시드

```bash
pnpx prisma migrate dev -n init
pnpx prisma generate
```

`prisma/seed.ts`(선택)

```ts
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
  await prisma.user.create({ data: { name: 'Justin', posts: { create: [{ title: 'Hello' }] } } });
}
main().finally(()=>prisma.$disconnect());
```

CI/CD 권장

```bash
pnpx prisma migrate deploy
```

---

#### 6. 트랜잭션

```ts
await this.prisma.$transaction(async (tx) => {
  const u = await tx.user.create({ data: { name: 'A' } });
  await tx.post.create({ data: { userId: u.id, title: 'T' } });
});
```

배치 트랜잭션

```ts
await this.prisma.$transaction([
  this.prisma.user.create({ data: { name: 'A' } }),
  this.prisma.post.create({ data: { title: 'T', userId: 1 } }),
]);
```

---

#### 7. 서비스 계층 샘플

```ts
@Injectable()
export class UserService {
  constructor(private readonly prisma: PrismaService) {}
  findAll() { return this.prisma.user.findMany({ include: { posts: true } }); }
  create(dto: { name: string }) { return this.prisma.user.create({ data: dto }); }
}
```

컨트롤러

```ts
@Controller('users')
export class UserController {
  constructor(private readonly service: UserService) {}
  @Get() list() { return this.service.findAll(); }
}
```

---

#### 8. 테스트

* Unit: Prisma 호출을 mock 또는 Testcontainers로 실제 DB 격리

```ts
const module = await Test.createTestingModule({
  providers: [UserService, PrismaService],
}).compile();
```

---

