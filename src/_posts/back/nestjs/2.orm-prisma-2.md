---
title: "Prisma Advanced (Practical Implementation Guide)"
date: 2025-10-25
---

**version: NestJS v10.x / Prisma v5.x / PostgreSQL 기준**

---

#### 요약

이 문서는 Prisma를 **실무 환경에 최적화**하기 위한 심화 예시 모음이다.  
트랜잭션, 관계 매핑, 마이그레이션 자동화, 운영 환경 구성, 성능 개선 등을 포함한다.

Prisma는 선언형 ORM이지만, 실무에서는 **트랜잭션 / 시드 / 마이그레이션 자동화 / 로깅**을 통해
**안정적인 데이터 계층 운영 체계**로 발전시킬 수 있다.
CI/CD 파이프라인과 결합하면 **완전 자동화된 데이터 관리 워크플로우**를 구축할 수 있다.

> *“Prisma는 선언적이지만, 운영은 전략적으로.”*

**핵심 포인트**
- 트랜잭션 및 에러 복구 전략
- 관계형 매핑과 `include` / `select` 활용
- CI/CD 마이그레이션 자동화
- 성능·로그·커넥션 풀 튜닝

---

##### 참고자료
- [Prisma Transactions Docs](https://www.prisma.io/docs/concepts/components/prisma-client/transactions)
- [NestJS with Prisma Best Practices](https://docs.nestjs.com/recipes/prisma)

---

#### 1. 트랜잭션 제어

**기본 트랜잭션**
```ts
await this.prisma.$transaction(async (tx) => {
  const user = await tx.user.create({ data: { name: 'Justin' } });
  await tx.post.create({ data: { title: 'Hello', userId: user.id } });
});
```

**배치 트랜잭션**

```ts
await this.prisma.$transaction([
  this.prisma.user.create({ data: { name: 'A' } }),
  this.prisma.post.create({ data: { title: 'B', userId: 1 } }),
]);
```

**트랜잭션 실패 처리**

```ts
try {
  await this.prisma.$transaction([...]);
} catch (err) {
  console.error('Rollback 발생:', err);
}
```

---

#### 2. 관계 매핑과 데이터 조회

```ts
// 관계형 include
this.prisma.user.findMany({
  include: { posts: { select: { title: true } } },
});

// 부분 select
this.prisma.user.findMany({
  select: { id: true, name: true },
});
```

> `include`는 관계 데이터 조회, `select`는 컬럼 단위 필드 제어용

---

#### 3. 마이그레이션 자동화 (CI/CD 연동)

CI 파이프라인 예시 (GitLab CI)

```yaml
deploy:
  stage: deploy
  script:
    - pnpm prisma migrate deploy
    - pnpm prisma generate
  environment: production
```

> 코드 변경 시 Schema 자동 반영 및 Client 재생성

---

#### 4. 시드 데이터 구성

`prisma/seed.ts`

```ts
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

async function main() {
  await prisma.user.create({
    data: {
      name: 'Justin',
      posts: { create: [{ title: 'Hello Prisma' }] },
    },
  });
}
main().finally(() => prisma.$disconnect());
```

실행 명령:

```bash
pnpx prisma db seed
```

---

#### 5. 운영 환경 구성

| 환경          | DATABASE_URL 예시                                  |
| ----------- | ------------------------------------------------ |
| **local**   | `postgresql://user:pw@localhost:5432/devdb`      |
| **staging** | `postgresql://user:pw@192.168.1.10:5432/stagedb` |
| **prod**    | `postgresql://user:pw@10.0.0.5:5432/proddb`      |

`.env`

```env
DATABASE_URL=${DATABASE_URL}
LOG_LEVEL=info
PRISMA_CLIENT_ENGINE_TYPE=binary
```

---

#### 6. 성능 최적화 가이드

| 항목                  | 전략                                              |
| ------------------- | ----------------------------------------------- |
| **Connection Pool** | PostgreSQL `pg-pool` 이용                         |
| **Lazy Query**      | `select` 사용해 최소 필드 조회                           |
| **N+1 방지**          | `include` or `prisma.$transaction` 활용           |
| **인덱스 관리**          | Prisma `@@index` 구문 사용                          |
| **Query Logging**   | `new PrismaClient({ log: ['query', 'error'] })` |


| 항목      | 팁                                               |
| ------- | ----------------------------------------------- |
| 커넥션 풀   | DB 드라이버(pool) 기본값 확인·조정                         |
| 인덱스     | `@@index`, `@unique` 적극 활용                      |
| N+1 완화  | `include` / `select`로 필요한 데이터만                  |
| 로깅      | `new PrismaClient({ log: ['query', 'error'] })` |
| 리드 레플리카 | URL로 읽기/쓰기 분리 구성(인프라 레벨)                        |

---

#### 7. 장애/트러블슈팅

| 문제           | 원인            | 해결                      |
| ------------ | ------------- | ----------------------- |
| `P2025`      | 레코드 없음        | try/catch로 비즈니스 예외 처리   |
| `P2002`      | Unique key 충돌 | DTO 유효성 검사 선행           |
| Migration 충돌 | Schema 변경 충돌  | `migrate resolve` 후 재배포 |

---

