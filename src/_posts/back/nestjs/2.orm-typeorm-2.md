---
title: "TypeORM Advanced (Practical Implementation Guide)"
date: 2025-10-25
---

**version: NestJS v10.x / TypeORM v0.3.x / PostgreSQL 기준**

---

#### 요약

이 문서는 TypeORM을 실무 환경에서 안정적이고 확장성 있게 운영하기 위한 심화 가이드이다.  
트랜잭션, 복잡한 쿼리, 관계 최적화, 마이그레이션 자동화, 성능 튜닝, 장애 대응을 다룬다.

**핵심 포인트**
- 트랜잭션 / QueryRunner 활용
- 고급 QueryBuilder / JOIN 전략
- 관계형 성능 최적화
- 마이그레이션 및 운영 팁

TypeORM은 Prisma보다 복잡하지만, **제어력·유연성·관계 제어 능력**이 뛰어나다.
트랜잭션·마이그레이션·성능 최적화를 체계적으로 적용하면
**대규모 트랜잭션 기반 서비스에서도 안정적으로 운영**할 수 있다.

> *“TypeORM은 제어의 예술이다 — 모든 SQL을 객체로 설계한다.”*
---

##### 참고자료
- [TypeORM Transactions](https://typeorm.io/#/transactions)
- [NestJS + TypeORM Best Practice](https://docs.nestjs.com/techniques/database)

---

#### 1. 트랜잭션 (Transaction Control)

```ts
await this.dataSource.transaction(async (manager) => {
  const user = await manager.save(User, { name: 'Justin' });
  await manager.save(Post, { title: 'Hello', user });
});
```

**수동 트랜잭션 제어**

```ts
const runner = this.dataSource.createQueryRunner();
await runner.connect();
await runner.startTransaction();

try {
  await runner.manager.save(User, { name: 'A' });
  await runner.commitTransaction();
} catch (err) {
  await runner.rollbackTransaction();
} finally {
  await runner.release();
}
```

---

#### 2. QueryBuilder 고급 활용

```ts
this.userRepo
  .createQueryBuilder('user')
  .leftJoinAndSelect('user.posts', 'post')
  .where('user.name ILIKE :name', { name: '%justin%' })
  .andWhere('post.title != :title', { title: 'Deprecated' })
  .orderBy('user.id', 'DESC')
  .take(10)
  .getMany();
```

> 복잡한 조건·Join·GroupBy·Subquery 등을 자유롭게 제어할 수 있다.

---

#### 3. 관계 최적화 & N+1 방지

| 문제            | 원인              | 해결 방법                       |
| ------------- | --------------- | --------------------------- |
| N+1 Query     | Lazy Loading 남용 | `join` / `relations` 명시적 로딩 |
| Over-fetching | 불필요한 컬럼 포함      | `select` 사용                 |
| Missing Index | 쿼리 느림           | DB 인덱스 관리                   |

```ts
this.userRepo.find({
  relations: { posts: true },
  select: ['id', 'name'],
});
```

---

#### 4. 마이그레이션 자동화 (CI/CD 연동)

GitLab CI 예시:

```yaml
migrate:
  stage: deploy
  script:
    - pnpx typeorm migration:run -d src/migrations
  environment: production
```

운영 시 원칙:

* `synchronize: false` 유지
* DB 버전 불일치 방지 위해 마이그레이션만으로 구조 변경
* 배포 파이프라인에서 자동 실행

---

#### 5. 성능 최적화 가이드

| 항목              | 전략                                           |
| --------------- | -------------------------------------------- |
| Connection Pool | `extra: { max: 20 }` 설정                      |
| 캐시              | Query Result Cache 사용 (`cache: true`)        |
| 로깅              | APM / OpenTelemetry 연동                       |
| 인덱스             | `@Index()` / DB 레벨 튜닝                        |
| 분리              | Read Replica 데이터소스 구성 (`readOnlyDataSource`) |

---

#### 6. 장애 대응 / 트러블슈팅

| 증상                                | 원인               | 해결             |
| --------------------------------- | ---------------- | -------------- |
| `QueryFailedError: duplicate key` | Unique 충돌        | 사전 유효성 검사      |
| `EntityNotFoundError`             | Lazy Loading 미처리 | `relations` 명시 |
| Connection Timeout                | Pool 부족          | 커넥션 수 조정       |

---

#### 7. 테스트 환경 구성

```ts
const module = await Test.createTestingModule({
  imports: [TypeOrmModule.forFeature([User])],
  providers: [UserService],
}).compile();
```

* `getRepositoryToken(Entity)` 으로 Mock 주입 가능
* Testcontainers로 격리된 DB 환경 구성 시 CI 안정성 ↑

---