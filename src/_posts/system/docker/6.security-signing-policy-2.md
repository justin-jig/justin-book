---
title: "서명 검증 및 정책 적용 (2) – OPA, Gatekeeper"
date: 2025-10-23
---

#### 요약  
서명된 이미지를 실제로 **배포 시점에 검증**하기 위해서는 정책 기반 접근이 필요하다.  
**OPA(Open Policy Agent)** 와 **Gatekeeper** 를 이용하면,  
서명되지 않은 이미지를 거부하거나 SBOM 검증을 자동화할 수 있다.  

* OPA와 Gatekeeper는 보안 정책을 코드로 정의하는 도구이다.
* Cosign과 연계하여 신뢰되지 않은 이미지 배포를 차단한다.
* SBOM 존재 여부까지 정책으로 검증하면 완전한 공급망 보안이 가능하다.

**핵심 정리**
- OPA는 정책(Policy) 엔진으로, JSON/YAML 데이터를 검증한다.  
- Gatekeeper는 Kubernetes Admission Controller로, 정책 적용을 자동화한다.  
- Cosign 서명과 SBOM 검증을 함께 적용하면 공급망 공격을 차단할 수 있다.  

##### 참고자료
- [Open Policy Agent](https://www.openpolicyagent.org/docs/latest/)
- [Gatekeeper Policy Library](https://github.com/open-policy-agent/gatekeeper-library)
- [Sigstore + OPA Integration Guide](https://docs.sigstore.dev/policy/)

---

#### 1. OPA 정책 예시
```rego
package docker.security

deny[msg] {
  input.image.signed == false
  msg := sprintf("Unsigned image detected: %v", [input.image.name])
}
```

> Cosign으로 서명되지 않은 이미지를 감지하면 배포를 차단한다.

---

#### 2. Gatekeeper Constraint 예시 (Kubernetes)

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredSignatures
metadata:
  name: require-signed-images
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
  parameters:
    signatures: ["cosign"]
```

> Gatekeeper는 Pod 생성 시 서명 검증을 자동으로 수행한다.

---

#### 3. SBOM 검증 자동화

OPA를 통해 SBOM을 정책에 포함할 수 있다.

```rego
deny[msg] {
  not input.sbom.exists
  msg := "SBOM metadata missing"
}
```

> 모든 배포 이미지는 SBOM을 포함해야 한다는 정책을 enforce.

---

#### 4. CI/CD 통합

배포 전 단계에서 서명 및 SBOM 검증을 자동화한다.

```bash
cosign verify myapp:1.0 && opa eval --input sbom.json --data policy.rego "data.docker.security.deny"
```

---

