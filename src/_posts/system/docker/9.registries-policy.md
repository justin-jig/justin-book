---
title: "이미지 보존 및 정리 정책 (Image Retention Policy)"
date: 2025-10-23
---

#### 요약  
레지스트리에 이미지가 쌓이면 저장소 공간과 관리 비용이 증가한다.  
이를 방지하기 위해 **보존 기간(Retention Policy)**, **태그 정리 규칙**,  
**자동 삭제 정책**을 설정해야 한다.  

* 레지스트리에는 자동 보존 정책을 반드시 적용해야 한다.
* Harbor/ECR은 Lifecycle Policy를 기본 제공한다.
* 주기적 Garbage Collection으로 저장소 용량을 효율적으로 유지한다.
  
**핵심 정리**
- 오래된 이미지나 불필요한 태그는 주기적으로 삭제.  
- Harbor, ECR 등은 자동 정리 정책을 지원.  
- “Stable / Latest / Release” 등 핵심 태그만 유지하는 것이 이상적.  

##### 참고자료
- [Harbor Retention Policy](https://goharbor.io/docs/2.10.0/administration/configure-retention/)
- [AWS ECR Lifecycle Policies](https://docs.aws.amazon.com/AmazonECR/latest/userguide/lifecycle_policy_examples.html)
- [Docker Registry GC (Garbage Collection)](https://docs.docker.com/registry/garbage-collection/)

---

#### 1. Harbor Retention 예시
```yaml
rules:
  - tag_selectors:
      - kind: "doublestar"
        pattern: "**"
    action: "retain"
    n: 5
    scope_selectors:
      repository:
        - kind: "doublestar"
          pattern: "myapp/*"
````

> 각 리포지토리별 최근 5개 태그만 유지하고 나머지는 자동 삭제된다.

---

#### 2. AWS ECR Lifecycle Policy 예시

```json
{
  "rules": [
    {
      "rulePriority": 1,
      "description": "Keep only 10 latest images",
      "selection": {
        "tagStatus": "any",
        "countType": "imageCountMoreThan",
        "countNumber": 10
      },
      "action": { "type": "expire" }
    }
  ]
}
```

> 최신 10개 이미지를 제외한 나머지를 자동 만료(expire) 처리한다.

---

#### 3. Docker Registry Garbage Collection

```bash
docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml
```

> 수동으로 이미지 레이어 캐시를 정리해 디스크 사용량을 줄인다.

---

#### 4. 운영 권장 방안

* Retention 정책: 30일 또는 최근 5~10 버전 유지
* `latest`, `stable`, `prod` 태그만 고정 유지
* 주기적 백업(`docker save`) 후 삭제로 안정성 확보

---

